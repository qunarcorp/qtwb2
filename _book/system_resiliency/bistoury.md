# 一站式Java应用诊断解决方案 - Bistoury
## 背景
2018年下半年，Alibaba开源了java应用诊断工具arthas，并多次登顶GitHub Trending。作为基础架构团队，我们自然也不会忽视这个东西。在研究后发现，arthas确实是一个非常优秀的java诊断工具，但是也有一些不足。
  
* 一是arthas更像是一个工具，而不像一个产品。如果要使用它，我们首先要登录相关机器，然后在机器上下载arthas，再执行一些命令来运行。这整个流程里，下载可能出现问题，运行arthas也需要具有目标进程相应的权限，还需要先看看对应进程id等等...这些确实只是一些小问题，但我们也可以选择让这些问题不存在，让整个使用过程更加流畅。
* 二是arthas缺少web界面。命令行界面用起来确实很酷，但不可否认在相当一部分情况下web界面更直观更友好，很多需要查文档的情况在web界面下都可以直接操作，降低了使用门槛。
* 三是arthas所有功能都针对单台机器，实际上很多时候我们需要考虑和观察整个应用的运行情况，需要一个应用级的视角。
* 四是arthas是一个独立的工具。对于一个开源工具，这不是一个缺点，但如果能和公司内部的应用中心、发布系统等做一些适配的话，在使用上会更方便，也能够做出一些独立工具做不到的功能。  

基于以上的原因，我们决定做一个更强大、更好用的java应用诊断工具 - Bistoury。Bistoury集成了arthas，拥有arthas的所有功能，并提供了在线debug、线程级cpu监控等killer feature，目前也已经在github开源。
  
## 设计与实现
### 整体设计
首先，我们先介绍一下bistoury整体上的设计。  
Bistoury涉及到的组件有用户系统、agent、proxy、ui、注册中心、负载均衡器、应用中心等，其中agent、proxy和ui直接归属于bistoury，其它都属于外部系统。  
* 用户系统就是待诊断的正在运行的应用。
* agent和待诊断用户系统部署在同一台机器上，接收来自proxy的命令，并根据其类型直接执行一部分命令，并负责另一部分命令与用户系统之间的交互。
* proxy负责维护与agent之间的长期netty连接，并以websocket的方式维护与ui在命令执行期间的连接，它将ui传来的命令发送给具体的一个或多个agent，并且根据网络情况对对应的连接进行管理。
* ui则提供图形化和命令行界面，接收用户请求并发送给proxy，并将结果展示给用户。
* 注册中心负责proxy的注册，ui通过注册中心获取proxy地址。
* 负载均衡器负责agent到proxy的负载均衡，agent在每次启动时通过负载均衡器获取单个proxy地址，并与之建立长期连接。
* 应用中心提供应用和机器的相关信息给bistoury，用于简化操作，并提供一些特殊功能需要的信息。
* 其它：bistoury还会访问gitlab等系统，但这些都是具体功能所需要，并不在bistoury整体的系统设计上。

### 字节码插桩
Bistoury的大量功能都使用了字节码插桩，同时因为bistoury agent与应用系统分开运行，所以使用agentmain方式动态attach到正在运行的用户系统上。  
字节码插桩和agentmain在网上有大量文章，这里不再进行具体说明。
### classloader设计